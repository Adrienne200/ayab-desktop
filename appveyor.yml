# see https://packaging.python.org/appveyor/#adding-appveyor-support-to-your-project
environment:
  # For Python versions available on Appveyor, see
  # http://www.appveyor.com/docs/installed-software#python
  # The list here is complete (excluding Python 2.6, which
  # isn't covered by this document) at the time of writing.
  PYTHON: "C:\\Python35"
  PATH: "%PATH%;%PYTHON%\\Lib\\site-packages\\PyQt5\\Qt\\bin"
  APPVEYOR_RDP_PASSWORD:
    secure: secure: gd/dxxrKL4GIBpIFqarUVhBeRISaOwo0QyQj320CFTY=

init:
  - ps: iex ((new-object net.webclient).DownloadString('https://raw.githubusercontent.com/appveyor/ci/master/scripts/enable-rdp.ps1'))

install:
  - "echo %PATH%"
  - "%PYTHON%\\python.exe -m pip install pyqt5 pyinstaller"
  - "%PYTHON%\\python.exe -m pip install -r requirements.txt"

build_script:
  - cmd: git describe --tags > package_version
  - cmd: set /p "PACKAGE_VERSION=" <package_version
  - "%PYTHON%\\python.exe -m PyInstaller -y ayab.spec"
  - git clone https://github.com/AllYarnsAreBeautiful/ayab-patterns dist\\ayab\\patterns
  - cmd: cmd /c "windows-build\\Inno Setup 5\\ISCC.exe" windows-build\\ayab.iss
  - 7z a -tzip AYAB-Windows10-%PACKAGE_VERSION%.zip "dist/ayab/*"
  - cmd: mv windows-build\\AYAB-Windows10-Setup.exe windows-build\\AYAB-Windows10-%PACKAGE_VERSION%-Setup.exe

artifacts:
- path: AYAB-Windows10*.zip
  name: standalone
- path: windows-build/AYAB-Windows10-*-Setup.exe
  name: installer

deploy:
- provider: GitHub
  # http://www.appveyor.com/docs/deployment/github
  tag: $(APPVEYOR_REPO_TAG_NAME)
  description: "Release $(APPVEYOR_REPO_TAG_NAME)"
  auth_token:
    secure: TZdJy8VQd+dRNFbFaDSYARdGg6Ca8+SfigFuvIxWwVzKBmL6qpT/XPxMCS6sRiQp
  artifact: installer
  force_update: true
  draft: false
  prerelease: true
  on:
    appveyor_repo_tag: true        # deploy on tag push only
- provider: GitHub
  # http://www.appveyor.com/docs/deployment/github
  tag: $(APPVEYOR_REPO_TAG_NAME)
  description: "Release $(APPVEYOR_REPO_TAG_NAME)"
  auth_token:
    secure: TZdJy8VQd+dRNFbFaDSYARdGg6Ca8+SfigFuvIxWwVzKBmL6qpT/XPxMCS6sRiQp
  artifact: standalone
  force_update: true
  draft: false
  prerelease: true
  on:
    appveyor_repo_tag: true        # deploy on tag push only
- provider: S3
  access_key_id: 
    secure: Wzv9KvWFF0Wlbji6KsLICZ0LA4OLMpTxzl9Lmjdep9g=
  secret_access_key: 
    secure: 7sipvYkOQirRfzSDKK5B67Poln90rNCYCI0To9I44lG0g3SABD/ol455HctusbUP
  bucket: ayab-debug
  region: eu-central-1
  unzip: false
  set_public: true
  artifact: installer
